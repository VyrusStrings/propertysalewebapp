{% extends "base.html" %}
{% load i18n l10n %}
{% load static %}
<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}">
<script src="{% static 'leaflet/leaflet.js' %}"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>

{% block title %}{% blocktrans with t=property.title c=property.city %}{{ t }} ‚Äî {{ c }}{% endblocktrans %}{% endblock %}
{% block content %}

<style>
  :root{--ink:#0f172a;--muted:#5b6b83;--line:#e6e9f0;--brand:#0b6aa8;--brand-2:#095782;--card:#fff;--radius:12px;--shadow:0 10px 26px rgba(16,24,40,.08)}

  .wrap{display:grid;gap:22px}
  @media(min-width:960px){.wrap{grid-template-columns:2fr 1fr}}

  /* ===== Gallery ===== */
  .gallery{display:grid;gap:10px}
  .hero-wrap{position:relative}
  .hero{width:100%;max-height:520px;object-fit:cover;border-radius:16px;border:1px solid var(--line);background:#eef2f7;box-shadow:var(--shadow)}
  .g-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:0;cursor:pointer;display:grid;place-items:center;font-size:22px;font-weight:800;color:#fff;background:linear-gradient(180deg,var(--brand) 0%,var(--brand-2) 100%);box-shadow:0 8px 18px rgba(11,106,168,.22);opacity:.92}
  .g-nav:hover{opacity:1}
  .g-nav.prev{left:10px}
  .g-nav.next{right:10px}

  .thumbs{display:flex;gap:10px;overflow:auto;padding:2px}
  .thumb{flex:0 0 auto;border:2px solid transparent;border-radius:10px;padding:0;background:#fff;cursor:pointer}
  .thumb img{display:block;width:110px;height:72px;object-fit:cover;border-radius:8px}
  .thumb.is-active{border-color:var(--brand)}
  @media(max-width:520px){.thumb img{width:92px;height:60px}}

  /* ===== Text blocks ===== */
  .title{margin:.7rem 0 .25rem;font-size:1.9rem;line-height:1.2}
  .facts{display:flex;flex-wrap:wrap;gap:10px 14px;align-items:center;color:var(--muted);margin:.35rem 0 1rem}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f4f7fb;border:1px solid #e7edf5;font-size:.92rem;color:#314155}
  .price-badge{font-weight:800;color:var(--ink);background:#fff;border:1px solid #eaeef4;border-radius:999px;padding:6px 12px;box-shadow:0 6px 16px rgba(16,24,40,.08)}

  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .panel h3{margin:.2rem 0 .6rem}
  @media(min-width:960px){.aside-sticky{position:sticky;top:20px;align-self:start}}

  .lead-form *{box-sizing:border-box}
  .lead-form p{display:flex;flex-direction:column;gap:6px;margin:0 0 12px}
  .lead-form label{margin:0;color:var(--muted);font-weight:600}
  .lead-form input,.lead-form select,.lead-form textarea{display:block;width:100%;padding:10px 12px;font-size:1rem;background:#fff;border:1px solid var(--line);border-radius:10px;outline:none;transition:border-color .15s ease,box-shadow .15s ease}
  .lead-form textarea{min-height:110px;resize:vertical}
  .lead-form input:focus,.lead-form select:focus,.lead-form textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(11,106,168,.16)}
  .summary{margin:0 0 12px;color:#233044}
  .desc p{margin:0 0 12px}

  /* --- Remote purchase pills --- */
.radio-pills{display:flex;gap:10px;flex-wrap:wrap}
.radio-pill{
  position:relative;display:inline-flex;align-items:center;gap:8px;
  padding:8px 14px;border:1px solid var(--line);border-radius:999px;
  background:#fff;color:#233044;cursor:pointer;font-weight:700;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.radio-pill input{position:absolute;inset:0;opacity:0;cursor:pointer}
.radio-pill span{pointer-events:none}
.radio-pill input:checked + span{
  color:#0b6aa8;
}
.radio-pill input:focus-visible + span{
  outline:2px solid #0b6aa8; outline-offset:2px; border-radius:999px;
}
.radio-pill:has(input:checked){
  border-color:#a7c8e6; box-shadow:0 0 0 4px rgba(11,106,168,.16); background:#f5fbff;
}

.flatpickr-calendar{
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  border-radius:12px;
  overflow:hidden;
  font-family: inherit;
}
.flatpickr-months .flatpickr-month{
  background:linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%);
  color:#fff;
}
.flatpickr-weekday{ color:#314155 }
.flatpickr-day.today{ border-color:#0b6aa8 }
.flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange{
  background:#0b6aa8; border-color:#0b6aa8; color:#fff;
}

</style>

<div class="wrap">

  <div>
    <!-- ===== Image Gallery ===== -->
    <div class="gallery">
      <div class="hero-wrap">
        <img id="heroImg" class="hero" src="{% if images and images.0 %}{{ images.0 }}{% elif property.cover %}{{ property.cover.url }}{% endif %}" alt="{{ property.title }}" loading="eager">
        {% if images|length > 1 %}
          <button class="g-nav prev" type="button" aria-label="{% trans 'Previous image' %}">‚Äπ</button>
          <button class="g-nav next" type="button" aria-label="{% trans 'Next image' %}">‚Ä∫</button>
        {% endif %}
      </div>

      {% if images %}
      <div class="thumbs" id="thumbs">
        {% for url in images %}
          <button class="thumb{% if forloop.first %} is-active{% endif %}" type="button" data-url="{{ url }}" aria-label="{% trans 'Show image' %} {{ forloop.counter }}">
            <img src="{{ url }}" alt="">
          </button>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- ===== Title & facts ===== -->
    <h1 class="title">{{ property.title }}</h1>

    <div class="facts">
      <span class="price-badge">¬£{{ property.price }}</span>
      <span class="chip">üìç {{ property.city }}</span>
      <span class="chip">üõèÔ∏è {{ property.bedrooms }} bd</span>
      <span class="chip">üõÅ {{ property.bathrooms }} ba</span>
      <span class="chip">üìê {{ property.size_sqm }} m¬≤</span>
    </div>

    {% if property.summary %}<p class="summary">{{ property.summary }}</p>{% endif %}

    <div class="panel desc">
      <h3>{% trans "Details" %}</h3>
      {{ property.description|linebreaks }}
    </div>

    {% if property.lat and property.lng %}
      <!-- Leaflet CSS/JS -->
      <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
      />
      <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
      ></script>

      <div class="panel" style="margin-top:16px">
        <h3>{% trans "Location" %}</h3>
        <div id="map" style="width:100%;height:360px;border:1px solid var(--line);border-radius:12px;"></div>
        <div style="margin-top:8px;">
        <a
          href="https://www.google.com/maps/search/?api=1&query={{ property.lat|unlocalize }},{{ property.lng|unlocalize }}"
          target="_blank" rel="noopener"
          style="text-decoration:none;color:#0b6aa8;font-weight:700"
        >
          {% trans "Open in Google Maps" %}
        </a>
        </div>
      </div>
    {% endif %}
  </div>
<!-- Sidebar lead form -->
<aside class="panel aside-sticky">
  <h3 style="margin-top:0">{% trans "Request Info" %}</h3>
  <form class="lead-form" method="post" action="{% url 'leads:create_for_property' property.slug %}">
    {% csrf_token %}

    <p>
      <label for="{{ form.full_name.id_for_label }}">{% trans "Full name" %}</label>
      {{ form.full_name }}
      {{ form.full_name.errors }}
    </p>

    <p>
      <label for="{{ form.email.id_for_label }}">{% trans "Email" %}</label>
      {{ form.email }}
      {{ form.email.errors }}
    </p>

    <p>
      <label for="{{ form.phone.id_for_label }}">{% trans "Phone" %}</label>
      {{ form.phone }}
      {{ form.phone.errors }}
    </p>

    <p>
      <label for="{{ form.country.id_for_label }}">{% trans "Country" %}</label>
      {{ form.country }}
      {{ form.country.errors }}
    </p>

    <div class="grid-2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <p>
        <label for="{{ form.budget_min.id_for_label }}">{% trans "Budget (min)" %}</label>
        {{ form.budget_min }}
        {{ form.budget_min.errors }}
      </p>
      <p>
        <label for="{{ form.budget_max.id_for_label }}">{% trans "Budget (max)" %}</label>
        {{ form.budget_max }}
        {{ form.budget_max.errors }}
      </p>
    </div>

    <!-- Remotely? Yes/No radios -->
    <fieldset style="margin:8px 0 0;padding:0;border:0">
      <legend style="margin:0 0 6px;color:#6b7280;font-weight:600">
        {% trans "Do you want to buy it remotely?" %}
      </legend>

      <div class="radio-pills">
        {% for sub in form.remote_choice %}
          <label class="radio-pill" for="{{ sub.id_for_label }}">
            {{ sub.tag }} <span>{{ sub.choice_label }}</span>
          </label>
        {% endfor %}
      </div>
      {{ form.remote_choice.errors }}
    </fieldset>

    <!-- Conditional date picker (shown only when "No") -->
    <div id="visitDateWrap" style="display:none;margin-top:8px">
      <label for="{{ form.visit_date.id_for_label }}" style="margin:0 0 6px;display:block;color:#6b7280;font-weight:600">
        {% trans "Choose the date that you are planning to come to Cyprus:" %}
      </label>
      {{ form.visit_date }}
      {{ form.visit_date.errors }}
    </div>

    <p>
      <label for="{{ form.message.id_for_label }}">{% trans "Message" %}</label>
      {{ form.message }}
      {{ form.message.errors }}
    </p>

    <button class="btn btn-primary btn-block" type="submit">{% trans "Send" %}</button>
  </form>
</aside>
</div>

<script>
(function(){
  /* ===== Gallery ===== */
  try {
    const hero = document.getElementById('heroImg');
    const thumbs = Array.from(document.querySelectorAll('#thumbs .thumb'));
    const prev = document.querySelector('.g-nav.prev');
    const next = document.querySelector('.g-nav.next');
    let idx = Math.max(0, thumbs.findIndex(b => b.classList.contains('is-active')));

    function select(i){
      if (!thumbs.length) return;
      idx = (i + thumbs.length) % thumbs.length;
      const url = thumbs[idx].dataset.url;
      if (url && hero) hero.src = url;
      thumbs.forEach(b => b.classList.remove('is-active'));
      thumbs[idx].classList.add('is-active');
      thumbs[idx].scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
    }

    thumbs.forEach((b,i)=> b.addEventListener('click', ()=>select(i)));
    prev && prev.addEventListener('click', ()=>select(idx-1));
    next && next.addEventListener('click', ()=>select(idx+1));
    if (thumbs.length <= 1){ prev?.remove(); next?.remove(); }

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft') select(idx-1);
      if (e.key === 'ArrowRight') select(idx+1);
    });
    if (hero){
      let x0=null;
      hero.addEventListener('touchstart', e=>{ x0 = e.touches[0].clientX; }, {passive:true});
      hero.addEventListener('touchend', e=>{
        if (x0==null) return;
        const dx = e.changedTouches[0].clientX - x0; x0=null;
        if (Math.abs(dx)>40) (dx<0? select(idx+1): select(idx-1));
      });
    }
  } catch(e){ console.warn('Gallery init error', e); }

  /* ===== Map (no early return!) ===== */
  try {
    const mapEl = document.getElementById('map');
    if (mapEl && typeof L !== 'undefined'){
      const lat = parseFloat('{{ property.lat|unlocalize|default_if_none:"" }}');
      const lng = parseFloat('{{ property.lng|unlocalize|default_if_none:"" }}');
      if (!isNaN(lat) && !isNaN(lng)){
        const map = L.map('map', { scrollWheelZoom:false });
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        const marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 14);
        marker.bindPopup("{{ property.title|escapejs }}");
        setTimeout(()=> map.invalidateSize(), 50);
      }
    }
  } catch(e){ console.warn('Map init error', e); }

  /* ===== Remote radios & date reveal ===== */
  try {
    const radios = document.querySelectorAll('input[name="remote_choice"]');
    const wrap = document.getElementById('visitDateWrap');
    function sync(){
      const val = Array.from(radios).find(r => r.checked)?.value;
      if (wrap) wrap.style.display = (val === 'no') ? 'block' : 'none';
    }
    radios.forEach(r => r.addEventListener('change', sync));
    sync();
  } catch(e){ console.warn('Remote/date toggle error', e); }

  /* ===== Flatpickr without touching forms.py ===== */
  try {
    const oldEl =
      document.getElementById('id_visit_date') ||
      document.getElementById('{{ form.visit_date.id_for_label }}') ||
      document.querySelector('input[name="visit_date"]');

    if (oldEl && typeof flatpickr !== 'undefined'){
      // Some browsers ignore changing type=date -> text. Replace node instead.
      const newEl = document.createElement('input');
      newEl.type = 'text';
      newEl.name = oldEl.name;
      newEl.id = oldEl.id || 'id_visit_date';
      newEl.className = oldEl.className || 'input';
      newEl.placeholder = oldEl.placeholder || '';
      newEl.autocomplete = 'off';
      // preserve value (yyyy-mm-dd) if submitted with errors
      if (oldEl.value) newEl.value = oldEl.value;

      oldEl.parentNode.replaceChild(newEl, oldEl);

      flatpickr(newEl, {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        allowInput: false,
        disableMobile: true,
        minDate: "today",
        defaultDate: newEl.value || null
      });
    }
  } catch(e){ console.warn('Datepicker init error', e); }
})();
</script>

{% endblock %}
