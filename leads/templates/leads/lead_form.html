{% extends "base.html" %}
{% load static i18n l10n %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
{% block title %}{% trans "Request Information" %}{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'django_countries/flags.css' %}">
<style>
  .lead-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
  .lead-head{margin-bottom:18px}
  .lead-title{margin:0 0 8px;font-size:2rem;line-height:1.1}
  .lead-sub{margin:0;color:var(--muted)}

  .row{display:grid;gap:14px;grid-template-columns:1fr}
  .row-2{grid-template-columns:1fr 1fr}
  @media (min-width:860px){
    .row{grid-template-columns:1fr 1fr}
    .row>div:nth-child(3){grid-column:1/-1}
  }
  /* Utility to span both columns */
  .col-span-2{grid-column:1/-1}

  label{display:block;margin:6px 0 6px;font-weight:600;color:var(--ink)}
  .lead-card input[type="text"],.lead-card input[type="email"],.lead-card input[type="number"],.lead-card select,.lead-card textarea{
    width:100%;box-sizing:border-box;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font:inherit;color:var(--ink);
    box-shadow:0 1px 0 rgba(2,8,23,.02);transition:border-color .15s ease,box-shadow .15s ease
  }
  .lead-card select{height:40px}
  .lead-card textarea{min-height:140px;resize:vertical}
  .lead-card input:focus,.lead-card select:focus,.lead-card textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(11,106,168,.15)}

  #id_country{padding-left:44px;background-repeat:no-repeat;background-position:10px 50%;background-size:24px 16px}
  .field-errors{margin-top:6px;color:#b42318;background:#fee4e2;border:1px solid #fda29b;border-radius:8px;padding:6px 10px;font-size:.95rem}
  .errors{margin-bottom:10px;color:#b42318;background:#fee4e2;border:1px solid #fda29b;border-radius:8px;padding:8px 12px}

  /* Radio pills like detail page */
  .radio-pills{display:flex;gap:10px;flex-wrap:wrap}
  .radio-pill{
    position:relative;display:inline-flex;align-items:center;gap:8px;
    padding:8px 14px;border:1px solid var(--line);border-radius:999px;
    background:#fff;color:#233044;cursor:pointer;font-weight:700;
    transition:border-color .15s, box-shadow .15s, background .15s;
  }
  .radio-pill input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .radio-pill span{pointer-events:none}
  .radio-pill:has(input:checked){border-color:#a7c8e6;box-shadow:0 0 0 4px rgba(11,106,168,.16);background:#f5fbff}
  .radio-pill input:checked + span{color:#0b6aa8}

  /* Flatpickr popup branded */
  .flatpickr-calendar{border:1px solid var(--line);box-shadow:var(--shadow);border-radius:12px;overflow:hidden;font-family:inherit;z-index:9999}
  .flatpickr-months .flatpickr-month{background:linear-gradient(180deg,var(--brand) 0%,var(--brand-2) 100%);color:#fff}
  .flatpickr-weekday{color:#314155}
  .flatpickr-day.today{border-color:#0b6aa8}
  .flatpickr-day.selected{background:#0b6aa8;border-color:#0b6aa8;color:#fff}

  /* Actions footer: centered button + small note underneath */
  .form-actions{display:flex;flex-direction:column;align-items:center;gap:10px}
  .form-actions .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 26px}
  .note{margin:0;color:var(--muted);text-align:center}

  /* Make the visible Flatpickr input match your styled inputs */
  .input, .lead-card .input { 
    width:100%;
    box-sizing:border-box;
    background:#fff;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px 12px;
    font:inherit;
    color:var(--ink);
    box-shadow:0 1px 0 rgba(2,8,23,.02);
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  .input:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(11,106,168,.15); }

  /* Give the date field a subtle calendar icon and consistent height */
  .input-date{
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='16' y1='2' x2='16' y2='6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position: calc(100% - 10px) 50%;
    background-size:18px;
    padding-right:36px; /* room for the icon */
  }

  /* Flatpickr injects an alt input; make sure it’s full width */
  .flatpickr-input, .flatpickr-alt-input { width:100%; }

</style>

<div class="lead-card">
  <div class="lead-head">
    <h1 class="lead-title">{% trans "Request Information" %}</h1>
    <p class="lead-sub">{% trans "Tell us a bit about you and your budget—our advisor will reach out shortly." %}</p>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    {% if form.non_field_errors %}<div class="errors">{{ form.non_field_errors }}</div>{% endif %}

    <div class="row">
      <div>
        <label for="{{ form.full_name.id_for_label }}">{% trans "Full Name" %}</label>
        {{ form.full_name }}{% if form.full_name.errors %}<div class="field-errors">{{ form.full_name.errors }}</div>{% endif %}
      </div>
      <div>
        <label for="{{ form.phone.id_for_label }}">{% trans "Phone / WhatsApp" %}</label>
        {{ form.phone }}{% if form.phone.errors %}<div class="field-errors">{{ form.phone.errors }}</div>{% endif %}
      </div>

      <div>
        <label for="{{ form.email.id_for_label }}">{% trans "Email" %}</label>
        {{ form.email }}{% if form.email.errors %}<div class="field-errors">{{ form.email.errors }}</div>{% endif %}
      </div>
      <div>
        <label for="{{ form.country.id_for_label }}">{% trans "Country" %}</label>
        {{ form.country }}{% if form.country.errors %}<div class="field-errors">{{ form.country.errors }}</div>{% endif %}
      </div>

      <div class="row row-2 col-span-2">
        <div>
          <label for="{{ form.budget_min.id_for_label }}">{% trans "Budget (Min)" %}</label>
          {{ form.budget_min }}{% if form.budget_min.errors %}<div class="field-errors">{{ form.budget_min.errors }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.budget_max.id_for_label }}">{% trans "Budget (Max)" %}</label>
          {{ form.budget_max }}{% if form.budget_max.errors %}<div class="field-errors">{{ form.budget_max.errors }}</div>{% endif %}
        </div>
      </div>

      <!-- Radios + Date in one full-width block -->
      <div class="col-span-2">
        <fieldset style="margin:8px 0 0;padding:0;border:0">
          <legend style="margin:0 0 6px;color:#6b7280;font-weight:600">
            {% trans "Do you want to buy it remotely?" %}
          </legend>
          <div class="radio-pills">
            {% for sub in form.remote_choice %}
              <label class="radio-pill" for="{{ sub.id_for_label }}">
                {{ sub.tag }} <span>{{ sub.choice_label }}</span>
              </label>
            {% endfor %}
          </div>
          {{ form.remote_choice.errors }}
        </fieldset>

        <!-- Date directly UNDER the radios -->
        <div id="visitDateWrap" style="display:none;margin-top:10px">
          <label for="{{ form.visit_date.id_for_label }}" style="margin:0 0 6px;display:block;color:#6b7280;font-weight:600">
            {% trans "Choose the date that you are planning to come to Cyprus" %}:
          </label>
          {{ form.visit_date }}
          {{ form.visit_date.errors }}
        </div>
      </div>

      <!-- Message keeps normal grid flow -->
      <div class="col-span-2">
        <label for="{{ form.message.id_for_label }}">{% trans "Message" %}</label>
        {{ form.message }}{% if form.message.errors %}<div class="field-errors">{{ form.message.errors }}</div>{% endif %}
      </div>

      <!-- Centered actions row -->
      <div class="form-actions col-span-2">
        <button class="btn btn-primary" type="submit">{% trans "Send" %}</button>
        <p class="note">{% trans "We respect your privacy. Your details are only used to respond to your request." %}</p>
      </div>
    </div>
  </form>
</div>

<script>
(function(){
  /* country flag in select */
  const sel=document.getElementById('id_country');
  const FLAG_TEMPLATE="{% static 'flags/__CODE__.gif' %}";
  const TRNC_URL="{% static 'img/flags/trnc.gif' %}";
  function urlFor(code){if(!code)return'';code=String(code).toLowerCase();if(code==='trnc')return TRNC_URL;return FLAG_TEMPLATE.replace('__CODE__',code)}
  function update(){if(!sel)return;const url=urlFor(sel.value||'');sel.style.backgroundImage=url?`url("${url}")`:'none'}
  document.addEventListener('DOMContentLoaded',function(){if(!sel)return;update();sel.addEventListener('change',update)})

  /* Toggle date block */
  const radios = document.querySelectorAll('input[name="remote_choice"]');
  const wrap = document.getElementById('visitDateWrap');
  function sync(){
    const val = Array.from(radios).find(r => r.checked)?.value;
    if (wrap) wrap.style.display = (val === 'no') ? 'block' : 'none';
  }
  radios.forEach(r => r.addEventListener('change', sync));
  sync();

  /* Flatpickr: replace native date input at runtime */
  const oldEl =
    document.getElementById('id_visit_date') ||
    document.getElementById('{{ form.visit_date.id_for_label }}') ||
    document.querySelector('input[name="visit_date"]');

  if (oldEl && typeof flatpickr !== 'undefined'){
    const newEl = document.createElement('input');
    newEl.type = 'text';
    newEl.name = oldEl.name;
    newEl.id = oldEl.id || 'id_visit_date';
    newEl.className = oldEl.className || 'input';
    newEl.placeholder = oldEl.placeholder || '';
    newEl.autocomplete = 'off';
    if (oldEl.value) newEl.value = oldEl.value;
    oldEl.parentNode.replaceChild(newEl, oldEl);

    flatpickr(newEl, {
      dateFormat: "Y-m-d",
      altInput: true,
      altInputClass: "input input-date",
      altFormat: "F j, Y",
      allowInput: false,
      disableMobile: true,
      minDate: "today",
      defaultDate: newEl.value || null
    });
  }
})();
</script>
{% endblock %}
